function getCalendarData(){$.get("DATA/events.csv",function(e){}).done(function(e){eventobjects=$.csv.toObjects(e),console.log(eventobjects.length+" events after first load"),checkDoubleEvents(eventobjects),checkYearlyEvents(eventobjects),checkMonthlyEvents(eventobjects),checkWeeklyEvents(eventobjects),createHolidays(holidays),store(eventobjects),console.timeEnd("calendarReadAndStore")})}function getHolidays(){$.ajax({url:"DATA/getcalendardata.php",data:{calendarURL:calendarJSONURL}}).done(function(e){console.log("php response: \n"+e),console.log("successfully copied holidays"),parseHolidays()}).fail(function(){alert("error in importing holidays")})}function parseHolidays(){$.getJSON("DATA/holidays.json",function(e){holidays=e,$.each(holidays,function(e,t){var n=moment(t.date);holidays[e].date=n.format("DD/MM/YYYY")}),console.log("successfully parsed holidays")})}function openData(){$.ajax({url:"DATA/copy.php"}).done(function(e){console.log("php response: \n"+e),console.log("successfully copied events"),getCalendarData()}).fail(function(){alert("error in getting events")})}function store(e){var t=JSON.stringify(e);$.ajax({type:"POST",url:"DATA/store.php",processData:!1,contentType:"application/json",data:t}).done(function(e){console.log("successfully stored events in cache")}).fail(function(){alert("error")})}function checkWeeklyEvents(e){$.each(e,function(e,t){"Wekelijks (ook op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,52*yearsAhead,"W",!0),"Wekelijks (niet op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,52*yearsAhead,"W",!1)}),console.log(e.length+" events after weekly check")}function checkMonthlyEvents(e){$.each(e,function(e,t){"Maandelijks (ook op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,12*yearsAhead,"M",!0),"Maandelijks (niet op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,12*yearsAhead,"M",!1)}),console.log(e.length+" events after monthly check")}function checkYearlyEvents(e){$.each(e,function(e,t){"Jaarlijks (ook op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,yearsAhead,"Y",!0),"Jaarlijks (niet op feestdagen)"==t["Terugkerend?"]&&pushNewEvent(t,yearsAhead,"Y",!1)}),console.log(e.length+" events after yearly check")}function checkDoubleEvents(e){var t,n,a,o=[],s=[],r=0;$.each(e,function(d,c){var i=moment(c.Startdatum,"DD/MM/YYYY"),Y=moment(c.Einddatum,"DD/MM/YYYY"),l=i.month()+1,m=Y.month()+1,h=i.year();if(Y.year()>h){for(o.push(d),startDateEvent=jQuery.extend(!0,{},c),startDateEvent.Einddatum=i.endOf("month").format("DD/MM/YYYY"),e.push(startDateEvent),r++,a=1;a<Y.diff(i,"months",!0);a++)s=[],s[a]=jQuery.extend(!0,{},c),n=i.clone().add(a-1,"months").startOf("month"),t=i.clone().add(a-1,"months").endOf("month"),s[a].Startdatum=n.format("DD/MM/YYYY"),s[a].Einddatum=t.format("DD/MM/YYYY"),console.log(s[a]),e.push(s[a]),r++;endDateEvent=jQuery.extend(!0,{},c),endDateEvent.Startdatum=Y.startOf("month").format("DD/MM/YYYY"),e.push(endDateEvent),r++}else if(m>l){for(o.push(d),startDateEvent=jQuery.extend(!0,{},c),startDateEvent.Einddatum=i.endOf("month").format("DD/MM/YYYY"),e.push(startDateEvent),r++,a=2;a<=m-l;a++)s=[],s[a]=jQuery.extend(!0,{},c),n=i.clone().add(a-1,"months").startOf("month"),t=i.clone().add(a-1,"months").endOf("month"),s[a].Startdatum=n.format("DD/MM/YYYY"),s[a].Einddatum=t.format("DD/MM/YYYY"),e.push(s[a]),r++;endDateEvent=jQuery.extend(!0,{},c),endDateEvent.Startdatum=Y.startOf("month").format("DD/MM/YYYY"),e.push(endDateEvent),r++}}),o.reverse(),$.each(o,function(t,n){e.splice(n,1)}),console.log(e.length+" events after check for events ("+r+"-"+o.length+") starting in a different month than ending")}function pushNewEvent(e,t,n,a){var o,s,r,d=moment(e.Startdatum,"DD/MM/YYYY"),c=moment(e.Einddatum,"DD/MM/YYYY");if("Y"==n){var i=now.diff(d,"years");for(noYears=1;noYears<=t+i;noYears++)tempEvent=jQuery.extend(!0,{},e),o=d.clone().add(noYears,"y"),s=c.clone().add(noYears,"y"),tempEvent.origStartDate=d.format("DD/MM/YYYY"),tempEvent.origEndDate=c.format("DD/MM/YYYY"),tempEvent.Startdatum=o.format("DD/MM/YYYY"),tempEvent.Einddatum=s.format("DD/MM/YYYY"),tempEvent.hash=createHash(o.format("DD/MM/YYYY"),s.format("DD/MM/YYYY"),tempEvent.Titel),r=!1,!1===a&&(r=compareToHolidays(o),console.log("special holidays")),!1===r&&eventobjects.push(tempEvent)}if("M"==n){var Y=now.diff(d,"months");for(noMonths=1;noMonths<=t+Y;noMonths++)tempEvent=jQuery.extend(!0,{},e),o=d.clone().add(noMonths,"M"),s=c.clone().add(noMonths,"M"),tempEvent.origStartDate=d.format("DD/MM/YYYY"),tempEvent.origEndDate=c.format("DD/MM/YYYY"),tempEvent.Startdatum=o.format("DD/MM/YYYY"),tempEvent.Einddatum=s.format("DD/MM/YYYY"),tempEvent.hash=createHash(o.format("DD/MM/YYYY"),s.format("DD/MM/YYYY"),tempEvent.Titel),r=!1,!1===a&&(r=compareToHolidays(o),console.log("special holidays")),!1===r&&eventobjects.push(tempEvent)}if("W"==n){var l=now.diff(d,"weeks");for(noWeeks=1;noWeeks<=t+l;noWeeks++)tempEvent=jQuery.extend(!0,{},e),o=d.clone().add(noWeeks,"w"),s=c.clone().add(noWeeks,"w"),tempEvent.origStartDate=d.format("DD/MM/YYYY"),tempEvent.origEndDate=c.format("DD/MM/YYYY"),tempEvent.Startdatum=o.format("DD/MM/YYYY"),tempEvent.Einddatum=s.format("DD/MM/YYYY"),tempEvent.hash=createHash(o.format("DD/MM/YYYY"),s.format("DD/MM/YYYY"),tempEvent.Titel),r=!1,!1===a&&(r=compareToHolidays(o),console.log("special holidays")),!1===r&&eventobjects.push(tempEvent)}}function compareToHolidays(e){return $.each(holidays,function(t,n){moment(n.date,"DD/MM/YYYY")==e?(console.log(tempEvent.titel+" is on a holiday! -- "+n.name),skipcreation=!0):skipcreation=!1}),skipcreation}function createHash(e,t,n){return e+"_"+t+"_"+encodeURI(n)}function createHolidays(e){$.each(e,function(e,t){var n=[],a=moment(t.date,"DD/MM/YYYY"),o=moment();a.diff(o,"years")<yearsAhead&&(n={Startdatum:t.date,Einddatum:t.date,Omschrijving:t.description+"("+t.age+" jaar oud)",Titel:t.name,WebURL:t.url,"CategoriÃ«n":"WTDIB special","URL omschrijving":"Meer informatie over: '"+t.name+"'"},t.age||(n.Omschrijving=t.description),n.hash=createHash(t.date,t.date,t.name),eventobjects.push(n))}),console.log(eventobjects.length+" events after adding public holidays")}var calendarJSONURL="http://www.webcal.fi/cal.php?id=75&format=json&start_year=previous_year&end_year=2022&tz=Europe%2FBerlin",yearsAhead=1,now=moment(),endInYears=now.clone().add(yearsAhead,"years"),eventobjects=[],holidays=[];$(document).ready(function(){getHolidays(),openData()});